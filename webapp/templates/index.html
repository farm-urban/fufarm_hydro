<!DOCTYPE html>
<title>JavaScript Example</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/normalize.css@8.0.1/normalize.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/sakura.css@1.3.1/css/sakura.css"
/>
<link
  rel="shortcut icon"
  href="{{ url_for('static', filename='favicon.ico') }}"
/>
<style>
  .group {
    display: flex;
    flex-direction: row;
  }
  form {
    display: flex;
  }
  label > input {
    width: 3em;
  }
  form > * {
    padding-right: 1em;
  }
  #result {
    font-weight: bold;
  }
</style>

<h1>FuFarm Autodoser</h1>
<hr />
<h4>Control Panel</h4>
<div class="group">
  <label for="select">Mode: </label>
  <select id="select">
    <optgroup label="Mode">
      <option value="monitor">Monitor</option>
      <option value="control">Control</option>
    </optgroup>
  </select>
</div>
<div class="group">
  <label for="calibrate">Run Calibration: </label>
  <input id="calibrate-btn" type="submit" value="Calibrate" />
</div>
<hr />
<div class="group">
  <label for="current-ec">Current EC:&nbsp</label>
  <output id="current-ec">42</output>
</div>
<div class="group">
  <label for="last-dosetime">Last Dose Time:&nbsp</label>
  <output id="last-dosetime">14:15</output>
</div>
<hr />
<h4>Set Parameters</h4>
<form id="set-parameters">
  <div>
    <div class="group">
      <label for="target-ec">Target EC: </label>
      <input id="target-ec" type="number" step="0.1" placeholder="1.8" />
    </div>
    <div class="group">
      <label for="equilibration-time">EquilibrationTime (s): </label>
      <input id="equilibration-time" type="number" step="1" placeholder="300" />
    </div>
    <div class="group">
      <label for="dose-duration">Dose duration (s): </label>
      <input id="dose-duration" type="number" step="1" placeholder="10" />
    </div>
    <div class="group">
      <label>a: </label>
      <input name="a" type="number" step="0.01" />
    </div>
    <div class="group">
      <label>b: </label>
      <input name="b" type="number" step="0.01" />
    </div>
    <input type="submit" value="Calculate" />
  </div>
</form>
<span>= <span id="result"></span></span>

<!-- <script src="{{url_for('static', filename='script.js')}}"></script> -->

<script>
  function getCurrentEC() {
    let url = {{ url_for('status')|tojson }} + '?' + new URLSearchParams({ q: 'current_ec'}).toString();
    fetch(url)
    .then(response => response.json())
    .then(updateEC);
  }

  function updateEC(data) {
    let span = document.getElementById('current-ec');
    span.innerText = data.ec;
  }


  function getLastDosetime() {
    let url = {{ url_for('status')|tojson }} + '?' + new URLSearchParams({ q: 'last_dose_time'}).toString();
    fetch(url)
    .then(response => response.json())
      .then(updateLastDosetime);
  }

  function updateLastDosetime(data) {
    let span = document.getElementById('last-dosetime');
    span.innerText = data.last_dose_time;
  }


  setInterval(getCurrentEC, 2000);
  setInterval(getLastDosetime, 2000);
</script>
